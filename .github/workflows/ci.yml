name: ci

on: [push, pull_request]

jobs:
#  ci-php8-jit:
#    runs-on: ubuntu-20.04
#    strategy:
#      fail-fast: false
#      matrix:
#        swoole: [4.7-php8.0]
#        mysql: [8.0]
#    env:
#      SWOOLE_DOCKER_VERSION: ${{ matrix.swoole }}
#      MYSQL_DOCKER_VERSION: ${{ matrix.mysql }}
#      ENV_SERVICE: swoole-php8
#      REDIS_SERVER_HOST: redis
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v2
#      - name: Cache dependencies
#        uses: actions/cache@v2
#        with:
#          path: /tmp/composer
#          key: ${{ runner.os }}-composer-${{ matrix.swoole }}-${{ hashFiles('**/composer.json') }}
#      - name: Prepare
#        uses: ./.github/actions/ci-prepare
#        with:
#          env: ${{ env.ENV_SERVICE }}
#      - name: Test
#        run: docker exec ${ENV_SERVICE} composer test
#      - name: Test swoole
#        run: docker exec ${ENV_SERVICE} composer test-swoole
#      - name: Test workerman
#        run: docker exec ${ENV_SERVICE} composer test-workerman
#      - name: Test workerman-gateway
#        run: docker exec ${ENV_SERVICE} composer test-workerman-gateway
#      - name: Test fpm
#        run: docker exec ${ENV_SERVICE} composer test-fpm
#      - name: Test jwt
#        run: docker exec ${ENV_SERVICE} composer test-jwt
#      - name: Test queue
#        run: docker exec ${ENV_SERVICE} composer test-queue
#      - name: Test amqp
#        run: docker exec ${ENV_SERVICE} composer test-amqp
#      - name: Test kafka
#        run: docker exec ${ENV_SERVICE} composer test-kafka
#      - name: Test grpc
#        run: docker exec ${ENV_SERVICE} composer test-grpc
#      - name: Test snowflake
#        run: docker exec ${ENV_SERVICE} composer test-snowflake
#      - name: Test mqtt
#        run: docker exec ${ENV_SERVICE} composer test-mqtt
#      - name: Test smarty
#        run: docker exec ${ENV_SERVICE} composer test-smarty
#      - name: Test pgsql
#        run: docker exec ${ENV_SERVICE} composer test-pgsql
#      - name: Print logs
#        if: failure()
#        run: docker exec ${ENV_SERVICE} php .github/print-logs.php
#
#  ci-php:
#    runs-on: ubuntu-20.04
#    strategy:
#      fail-fast: false
#      matrix:
#        swoole: [4.7-php7.4, 4.7-php8.0]
#        mysql: [5.7, 8.0]
#    env:
#      SWOOLE_DOCKER_VERSION: ${{ matrix.swoole }}
#      MYSQL_DOCKER_VERSION: ${{ matrix.mysql }}
#      ENV_SERVICE: swoole
#      REDIS_SERVER_HOST: redis
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v2
#      - name: Cache dependencies
#        uses: actions/cache@v2
#        with:
#          path: /tmp/composer
#          key: ${{ runner.os }}-composer-${{ matrix.swoole }}-${{ hashFiles('**/composer.json') }}
#      - name: Prepare
#        uses: ./.github/actions/ci-prepare
#        with:
#          env: ${{ env.ENV_SERVICE }}
#      - name: Test
#        run: docker exec ${ENV_SERVICE} composer test
#      - name: Test swoole
#        run: docker exec ${ENV_SERVICE} composer test-swoole
#      - name: Test workerman
#        run: docker exec ${ENV_SERVICE} composer test-workerman
#      - name: Test workerman-gateway
#        run: docker exec ${ENV_SERVICE} composer test-workerman-gateway
#      - name: Test fpm
#        run: docker exec ${ENV_SERVICE} composer test-fpm
#      - name: Test jwt
#        run: docker exec ${ENV_SERVICE} composer test-jwt
#      - name: Test queue
#        run: docker exec ${ENV_SERVICE} composer test-queue
#      - name: Test amqp
#        run: docker exec ${ENV_SERVICE} composer test-amqp
#      - name: Test kafka
#        run: docker exec ${ENV_SERVICE} composer test-kafka
#      - name: Test grpc
#        run: docker exec ${ENV_SERVICE} composer test-grpc
#      - name: Test snowflake
#        run: docker exec ${ENV_SERVICE} composer test-snowflake
#      - name: Test mqtt
#        run: docker exec ${ENV_SERVICE} composer test-mqtt
#      - name: Test smarty
#        run: docker exec ${ENV_SERVICE} composer test-smarty
#      - name: Test pgsql
#        run: docker exec ${ENV_SERVICE} composer test-pgsql
#      - name: Print logs
#        if: failure()
#        run: docker exec ${ENV_SERVICE} php .github/print-logs.php
#
#  ci-php-unix:
#    runs-on: ubuntu-20.04
#    strategy:
#      fail-fast: false
#      matrix:
#        swoole: [ 4.7-php8.0 ]
#        mysql: [ 8.0 ]
#    env:
#      ENV_SERVICE: swoole
#      SWOOLE_DOCKER_VERSION: ${{ matrix.swoole }}
#      MYSQL_DOCKER_VERSION: ${{ matrix.mysql }}
#      REDIS_SERVER_HOST: /tmp/docker/redis.sock
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v2
#      - name: Cache dependencies
#        uses: actions/cache@v2
#        with:
#          path: /tmp/composer
#          key: ${{ runner.os }}-composer-${{ matrix.swoole }}-${{ hashFiles('**/composer.json') }}
#      - name: Prepare
#        uses: ./.github/actions/ci-prepare
#        with:
#          env: ${{ env.ENV_SERVICE }}
#      - name: Test
#        run: docker exec ${ENV_SERVICE} composer test
#      - name: Test swoole
#        run: docker exec ${ENV_SERVICE} composer test-swoole
#      - name: Test workerman
#        run: docker exec ${ENV_SERVICE} composer test-workerman
#      - name: Test workerman-gateway
#        run: docker exec ${ENV_SERVICE} composer test-workerman-gateway
#      - name: Test fpm
#        run: docker exec ${ENV_SERVICE} composer test-fpm
#      - name: Test jwt
#        run: docker exec ${ENV_SERVICE} composer test-jwt
#      - name: Test queue
#        run: docker exec ${ENV_SERVICE} composer test-queue
#      - name: Test amqp
#        run: docker exec ${ENV_SERVICE} composer test-amqp
#      - name: Test kafka
#        run: docker exec ${ENV_SERVICE} composer test-kafka
#      - name: Test grpc
#        run: docker exec ${ENV_SERVICE} composer test-grpc
#      - name: Test snowflake
#        run: docker exec ${ENV_SERVICE} composer test-snowflake
#      - name: Test mqtt
#        run: docker exec ${ENV_SERVICE} composer test-mqtt
#      - name: Test smarty
#        run: docker exec ${ENV_SERVICE} composer test-smarty
#      - name: Test pgsql
#        run: docker exec ${ENV_SERVICE} composer test-pgsql
#      - name: Print logs
#        if: failure()
#        run: docker exec ${ENV_SERVICE} php .github/print-logs.php

  ci-macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        php: [7.4]
        swoole: [v4.7.1]
    env:
      MYSQL_SERVER_PASSWORD: ""
      PHP_VERSION: ${{ matrix.php }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup MySQL
        uses: shogo82148/actions-setup-mysql@v1
        with:
          mysql-version: "8.0"
          root-password: root
      - name: Setup Redis
        uses: shogo82148/actions-setup-redis@v1
        with:
          redis-version: '6.x'
      - name: Get Openssl Dir
        id: opecssl-dir
        run: echo "::set-output name=path::$(brew --prefix openssl)"
      - name: Setup PHP
        uses: shivammathur/setup-php@verbose
        with:
          php-version: ${{ matrix.php }}
          tools: pecl
          extensions: >
            bcmath, curl, openssl, mbstring, intl, json, igbinary, redis, mysqli, pdo, pdo_mysql, sockets,
            hprose, swoole-swoole/swoole-src@${{ matrix.swoole }}
        env:
          SWOOLE_CONFIGURE_OPTS: >
            --enable-openssl
            --with-openssl-dir=${{ steps.opecssl-dir.outputs.path }}
            --enable-http2
            --enable-mysqlnd
            --enable-swoole-json
            --enable-swoole-curl
      - name: Check Version
        run: |
          php -v
          php -m
          composer -V
          php --ri swoole
      - name: Get composer cache directory
        id: composer-cache
        run: echo "::set-output name=dir::$(composer config cache-files-dir)"
      - name: Cache dependencies
        uses: actions/cache@v2
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ env.php-versions }}-${{ hashFiles('**/composer.json') }}
      - name: Prepare
        run: |
          mysql -uroot -proot -e 'CREATE DATABASE IF NOT EXISTS db_imi_test;'
          composer update --prefer-dist --no-progress
          php src/Cli/bin/imi-cli generate/table --app-namespace "Imi\Test\Component"
#          mysql -uroot -e 'CREATE DATABASE IF NOT EXISTS db_imi_test;'
#          tests/db/install-db.sh
      - name: Test
        run: composer test
      - name: Test swoole
        run: composer test-swoole
      - name: Test workerman
        run: composer test-workerman
      - name: Test workerman-gateway
        run: composer test-workerman-gateway
      - name: Test fpm
        run: composer test-fpm
      - name: Test jwt
        run: composer test-jwt
      - name: Test queue
        run: composer test-queue
      - name: Test grpc
        run: composer test-grpc
      - name: Test snowflake
        run: composer test-snowflake
      - name: Test mqtt
        run: composer test-mqtt
      - name: Test smarty
        run: composer test-smarty
      - name: Print logs
        if: failure()
        run: php .github/print-logs.php

#  ci-windows:
#    runs-on: windows-latest
#
#    steps:
#      - uses: actions/checkout@v2
#
#      - name: Setup MySQL
#        uses: shogo82148/actions-setup-mysql@v1
#        with:
#          mysql-version: "8.0"
#          root-password: root
#
#      - name: Setup Redis-server
#        run: |
#          nuget install redis-64 -excludeversion
#          redis-64\tools\redis-server.exe --service-install
#          redis-64\tools\redis-server.exe --service-start
#          '@ECHO Redis Started'
#
#      - name: Setup PHP
#        uses: shivammathur/setup-php@v2
#        with:
#          php-version: 7.4
#          ini-values: session.save_path=C:\temp
#          tools: pecl
#          extensions: bcmath, curl, openssl, mbstring, intl, json, igbinary, redis, mysqli, pdo, pdo_mysql, sockets, event
#
#      - name: Get composer cache directory
#        id: composer-cache
#        run: echo "::set-output name=dir::$(composer config cache-files-dir)"
#      - name: Cache dependencies
#        uses: actions/cache@v2
#        with:
#          path: ${{ steps.composer-cache.outputs.dir }}
#          key: ${{ runner.os }}-composer-${{ env.php-versions }}-${{ hashFiles('**/composer.json') }}
#
#      - name: Prepare
#        run: |
#          mysql -uroot -proot -e 'CREATE DATABASE IF NOT EXISTS db_imi_test;'
#          composer update --prefer-dist --no-progress
#          php src/Cli/bin/imi-cli generate/table --app-namespace "Imi\Test\Component"
#
#      - name: Test
#        run: php tests\phpunit -c .\tests\phpunit.xml
#      - name: Test fpm
#        run: php tests\phpunit -c src\Components\fpm\tests\phpunit.xml
#      - name: Test workerman
#        run: php tests\phpunit -c src\Components\workerman\tests\phpunit.xml
#      - name: Test workerman-gateway
#        run: php tests\phpunit -c src\Components\workerman-gateway\tests\phpunit.xml --testsuite workerman
#      - name: Print logs
#        if: failure()
#        run: php .github/print-logs.php
