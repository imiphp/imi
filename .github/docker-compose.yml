version: "3.4"

services:
  shared-tmp:
    image: busybox
    container_name: shared-tmp
    command: /tmp/shared-env.sh
    volumes:
      - /run/shared:/run/shared
      - ./shared-env.sh:/tmp/shared-env.sh

  mysql:
    image: mysql:${MYSQL_DOCKER_VERSION}
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
      MYSQL_DATABASE: "db_imi_test"
      TZ: "Asia/Shanghai"
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - 3306:3306
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  postgres:
    image: postgres:13
    container_name: "postgres"
    environment:
      POSTGRES_USER: root
      POSTGRES_DB: db_imi_test
      POSTGRES_PASSWORD: root
    ports:
      - "5432:5432"
    volumes:
      - "${GITHUB_WORKSPACE}:/imi:rw"

  redis:
    image: redis:6-alpine
    container_name: redis
    depends_on:
      - shared-tmp
    command: redis-server /etc/redis.conf
    volumes:
      - ./redis.conf:/etc/redis.conf
      - /run/shared:/run/shared
    ports:
      - 6379:6379

  redis-new:
    image: bitnami/redis:7.2
    container_name: redis-new
    depends_on:
      - shared-tmp
    volumes:
      - "${GITHUB_WORKSPACE}/.github/service/redis-tls/certs:/opt/bitnami/redis/certs"
      - /run/shared:/run/shared
    environment:
      REDIS_PORT_NUMBER: 6377
      REDIS_PASSWORD: "l83aa26"
      REDIS_TLS_ENABLED: "true"
      REDIS_TLS_PORT_NUMBER: 6443
      REDIS_TLS_CERT_FILE: "/opt/bitnami/redis/certs/redis.crt"
      REDIS_TLS_KEY_FILE: "/opt/bitnami/redis/certs/redis.key"
      REDIS_TLS_DH_PARAMS_FILE: "/opt/bitnami/redis/certs/redis.dh"
      REDIS_TLS_CA_FILE: "/opt/bitnami/redis/certs/ca.crt"
      REDIS_TLS_AUTH_CLIENTS: "yes"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 -p 6377 -a l83aa26 INFO | grep 'redis_version'"]
      interval: 3s
      timeout: 60s
      retries: 30
    ports:
      - "6377:6377"
      - "6443:6443"

  rabbitmq:
    container_name: rabbitmq
    image: "rabbitmq:3.8-management"
    environment:
      RABBITMQ_DEFAULT_VHOST: "/"
      RABBITMQ_DEFAULT_USER: "guest"
      RABBITMQ_DEFAULT_PASS: "guest"
    ports:
      - "4369:4369"
      - "15672:15672"
      - "5672:5672"
      - "25672:25672"

  zookeeper:
    container_name: zookeeper
    image: zookeeper:3.4
    ports:
      - "2181:2181"

  kafka1:
    container_name: kafka1
    image: wurstmeister/kafka:2.13-2.7.0
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ADVERTISED_HOST_NAME: kafka1
      KAFKA_ADVERTISED_PORT: 9092
      KAFKA_HOST_NAME: kafka1
      KAFKA_PORT: 9092
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      HOSTNAME_COMMAND: hostname -i
      KAFKA_LISTENERS: PLAINTEXT://kafka1:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1:9092
      KAFKA_NUM_PARTITIONS: 3
    ports:
      - "9092:9092"

  redis-cluster-node-1:
    container_name: redis-cluster-node-1
    image: bitnami/redis-cluster:7.2
    volumes:
      - "${GITHUB_WORKSPACE}/.github/service/redis-tls/certs:/opt/bitnami/redis/certs"
    environment:
      REDIS_PORT_NUMBER: 6480
      REDIS_PASSWORD: "l83aa26"
      REDIS_NODES: "redis-cluster-node-1:6445 redis-cluster-node-2:6446 redis-cluster-node-3:6447 redis-cluster-node-4:6448 redis-cluster-node-5:6449 redis-cluster-node-0:6444"
      REDIS_TLS_ENABLED: "true"
      REDIS_TLS_PORT_NUMBER: 6445
      REDIS_TLS_CERT_FILE: "/opt/bitnami/redis/certs/redis.crt"
      REDIS_TLS_KEY_FILE: "/opt/bitnami/redis/certs/redis.key"
      REDIS_TLS_DH_PARAMS_FILE: "/opt/bitnami/redis/certs/redis.dh"
      REDIS_TLS_CA_FILE: "/opt/bitnami/redis/certs/ca.crt"
      REDIS_TLS_AUTH_CLIENTS: "yes"
    ports:
      - "6480:6480"
      - "6445:6445"

  redis-cluster-node-2:
    container_name: redis-cluster-node-2
    image: bitnami/redis-cluster:7.2
    volumes:
      - "${GITHUB_WORKSPACE}/.github/service/redis-tls/certs:/opt/bitnami/redis/certs"
    environment:
      REDIS_PORT_NUMBER: 6481
      REDIS_PASSWORD: "l83aa26"
      REDIS_NODES: "redis-cluster-node-1:6445 redis-cluster-node-2:6446 redis-cluster-node-3:6447 redis-cluster-node-4:6448 redis-cluster-node-5:6449 redis-cluster-node-0:6444"
      REDIS_TLS_ENABLED: "true"
      REDIS_TLS_PORT_NUMBER: 6446
      REDIS_TLS_CERT_FILE: "/opt/bitnami/redis/certs/redis.crt"
      REDIS_TLS_KEY_FILE: "/opt/bitnami/redis/certs/redis.key"
      REDIS_TLS_DH_PARAMS_FILE: "/opt/bitnami/redis/certs/redis.dh"
      REDIS_TLS_CA_FILE: "/opt/bitnami/redis/certs/ca.crt"
      REDIS_TLS_AUTH_CLIENTS: "yes"
    ports:
      - "6481:6481"
      - "6446:6446"

  redis-cluster-node-3:
    container_name: redis-cluster-node-3
    image: bitnami/redis-cluster:7.2
    volumes:
      - "${GITHUB_WORKSPACE}/.github/service/redis-tls/certs:/opt/bitnami/redis/certs"
    environment:
      REDIS_PORT_NUMBER: 6482
      REDIS_PASSWORD: "l83aa26"
      REDIS_NODES: "redis-cluster-node-1:6445 redis-cluster-node-2:6446 redis-cluster-node-3:6447 redis-cluster-node-4:6448 redis-cluster-node-5:6449 redis-cluster-node-0:6444"
      REDIS_TLS_ENABLED: "true"
      REDIS_TLS_PORT_NUMBER: 6447
      REDIS_TLS_CERT_FILE: "/opt/bitnami/redis/certs/redis.crt"
      REDIS_TLS_KEY_FILE: "/opt/bitnami/redis/certs/redis.key"
      REDIS_TLS_DH_PARAMS_FILE: "/opt/bitnami/redis/certs/redis.dh"
      REDIS_TLS_CA_FILE: "/opt/bitnami/redis/certs/ca.crt"
      REDIS_TLS_AUTH_CLIENTS: "yes"
    ports:
      - "6482:6482"
      - "6447:6447"

  redis-cluster-node-4:
    container_name: redis-cluster-node-4
    image: bitnami/redis-cluster:7.2
    volumes:
      - "${GITHUB_WORKSPACE}/.github/service/redis-tls/certs:/opt/bitnami/redis/certs"
    environment:
      REDIS_PORT_NUMBER: 6483
      REDIS_PASSWORD: "l83aa26"
      REDIS_NODES: "redis-cluster-node-1:6445 redis-cluster-node-2:6446 redis-cluster-node-3:6447 redis-cluster-node-4:6448 redis-cluster-node-5:6449 redis-cluster-node-0:6444"
      REDIS_TLS_ENABLED: "true"
      REDIS_TLS_PORT_NUMBER: 6448
      REDIS_TLS_CERT_FILE: "/opt/bitnami/redis/certs/redis.crt"
      REDIS_TLS_KEY_FILE: "/opt/bitnami/redis/certs/redis.key"
      REDIS_TLS_DH_PARAMS_FILE: "/opt/bitnami/redis/certs/redis.dh"
      REDIS_TLS_CA_FILE: "/opt/bitnami/redis/certs/ca.crt"
      REDIS_TLS_AUTH_CLIENTS: "yes"
    ports:
      - "6483:6483"
      - "6448:6448"

  redis-cluster-node-5:
    container_name: redis-cluster-node-5
    image: bitnami/redis-cluster:7.2
    volumes:
      - "${GITHUB_WORKSPACE}/.github/service/redis-tls/certs:/opt/bitnami/redis/certs"
    environment:
      REDIS_PORT_NUMBER: 6484
      REDIS_PASSWORD: "l83aa26"
      REDIS_NODES: "redis-cluster-node-1:6445 redis-cluster-node-2:6446 redis-cluster-node-3:6447 redis-cluster-node-4:6448 redis-cluster-node-5:6449 redis-cluster-node-0:6444"
      REDIS_TLS_ENABLED: "true"
      REDIS_TLS_PORT_NUMBER: 6449
      REDIS_TLS_CERT_FILE: "/opt/bitnami/redis/certs/redis.crt"
      REDIS_TLS_KEY_FILE: "/opt/bitnami/redis/certs/redis.key"
      REDIS_TLS_DH_PARAMS_FILE: "/opt/bitnami/redis/certs/redis.dh"
      REDIS_TLS_CA_FILE: "/opt/bitnami/redis/certs/ca.crt"
      REDIS_TLS_AUTH_CLIENTS: "yes"
    ports:
      - "6484:6484"
      - "6449:6449"

  redis-cluster-node-0:
    container_name: redis-cluster-node-0
    image: bitnami/redis-cluster:7.2
    depends_on:
      - redis-cluster-node-1
      - redis-cluster-node-2
      - redis-cluster-node-3
      - redis-cluster-node-4
      - redis-cluster-node-5
    volumes:
      - "${GITHUB_WORKSPACE}/.github/service/redis-tls/certs:/opt/bitnami/redis/certs"
    environment:
      REDIS_AOF_ENABLED: "no"
      REDIS_PORT_NUMBER: 6479
      REDIS_PASSWORD: "l83aa26"
      REDIS_NODES: "redis-cluster-node-1:6445 redis-cluster-node-2:6446 redis-cluster-node-3:6447 redis-cluster-node-4:6448 redis-cluster-node-5:6449 redis-cluster-node-0:6444"
      REDIS_CLUSTER_REPLICAS: "1"
      REDIS_CLUSTER_CREATOR: "yes"
      REDIS_TLS_ENABLED: "true"
      REDIS_TLS_PORT_NUMBER: 6444
      REDIS_TLS_CERT_FILE: "/opt/bitnami/redis/certs/redis.crt"
      REDIS_TLS_KEY_FILE: "/opt/bitnami/redis/certs/redis.key"
      REDIS_TLS_DH_PARAMS_FILE: "/opt/bitnami/redis/certs/redis.dh"
      REDIS_TLS_CA_FILE: "/opt/bitnami/redis/certs/ca.crt"
      REDIS_TLS_AUTH_CLIENTS: "yes"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 -p $${REDIS_PORT_NUMBER} -a $${REDIS_PASSWORD} CLUSTER INFO | grep 'cluster_state:ok'"]
      interval: 3s
      timeout: 60s
      retries: 30
    ports:
      - "6479:6479"
      - "6444:6444"

  swoole:
    container_name: "swoole"
    image: ghcr.io/${REPOSITORY_OWNER}/imi-swoole-test:${IMAGE_VERSION}
    depends_on:
      - shared-tmp
      - mysql
      - redis
      - redis-new
      - rabbitmq
      - kafka1
      - postgres
      - redis-cluster-node-0
    environment:
      MYSQL_SERVER_HOST: mysql
      REDIS_SERVER_HOST: ${REDIS_SERVER_HOST}
      PGSQL_SERVER_HOST: postgres
      MYSQL_SERVER_PASSWORD: ""
      AMQP_SERVER_HOST: "rabbitmq"
      KAFKA_BOOTSTRAP_SERVERS: "kafka1:9092"
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      REDIS_SERVER_CLUSTER_PASSWORD: "l83aa26"
      REDIS_SERVER_CLUSTER_SEEDS: "172.10.1.2:6379,172.10.1.3:6379,172.10.1.4:6379,172.10.1.5:6379,172.10.1.6:6379,172.10.1.7:6379"
      REDIS_SERVER_TLS_CLUSTER_SEEDS: "172.10.1.2:6443,172.10.1.3:6443,172.10.1.4:6443,172.10.1.5:6443,172.10.1.6:6443,172.10.1.7:6443"
      REDIS_SERVER_UNIX_SOCK: "/run/shared/redis.sock"
      REDIS_SERVER_TLS_HOST: "redis-new"
      REDIS_SERVER_TLS_PORT: "6443"
      REDIS_SERVER_TLS_PASSWORD: "l83aa26"
      REDIS_SERVER_TLS_CA_FILE: "/imi/.github/service/redis-tls/certs/ca.crt"
      REDIS_SERVER_TLS_CERT_FILE: "/imi/.github/service/redis-tls/certs/client.crt"
      REDIS_SERVER_TLS_KEY_FILE: "/imi/.github/service/redis-tls/certs/client.key"
    volumes:
      - "${GITHUB_WORKSPACE}:/imi:rw"
      - /run/shared:/run/shared
    working_dir: /imi
    command: tail -f /dev/null
    tty: true

  php:
    container_name: "php"
    depends_on:
      - shared-tmp
      - mysql
      - redis
      - redis-new
      - rabbitmq
      - kafka1
      - postgres
      - redis-cluster-node-0
    environment:
      MYSQL_SERVER_HOST: mysql
      REDIS_SERVER_HOST: ${REDIS_SERVER_HOST}
      PGSQL_SERVER_HOST: postgres
      MYSQL_SERVER_PASSWORD: ""
      AMQP_SERVER_HOST: "rabbitmq"
      KAFKA_BOOTSTRAP_SERVERS: "kafka1:9092"
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      REDIS_SERVER_CLUSTER_PASSWORD: "l83aa26"
      REDIS_SERVER_CLUSTER_SEEDS: "172.10.1.2:6379,172.10.1.3:6379,172.10.1.4:6379,172.10.1.5:6379,172.10.1.6:6379,172.10.1.7:6379"
      REDIS_SERVER_TLS_CLUSTER_SEEDS: "172.10.1.2:6443,172.10.1.3:6443,172.10.1.4:6443,172.10.1.5:6443,172.10.1.6:6443,172.10.1.7:6443"
      REDIS_SERVER_UNIX_SOCK: "/run/shared/redis.sock"
      REDIS_SERVER_TLS_HOST: "redis-new"
      REDIS_SERVER_TLS_PORT: "6443"
      REDIS_SERVER_TLS_PASSWORD: "l83aa26"
      REDIS_SERVER_TLS_CA_FILE: "/imi/.github/service/redis-tls/certs/ca.crt"
      REDIS_SERVER_TLS_CERT_FILE: "/imi/.github/service/redis-tls/certs/client.crt"
      REDIS_SERVER_TLS_KEY_FILE: "/imi/.github/service/redis-tls/certs/client.key"
    build:
      context: .
      dockerfile: php.dockerfile
      args:
        PHP_VERSION: ${PHP_VERSION}
        SWOOLE_VERSION: ${SWOOLE_VERSION}
        ROADRUNNER_DOCKER_VERSION: ${ROADRUNNER_DOCKER_VERSION}
        POSTGRESQL_VERSION: ${POSTGRESQL_VERSION}
    volumes:
      - "${GITHUB_WORKSPACE}:/imi:rw"
      - "/tmp/base_cache:/tmp/base_cache:rw"
      - /run/shared:/run/shared
    working_dir: /imi
    command: tail -f /dev/null

  swoole-only:
    container_name: "swoole-only"
    image: ghcr.io/${REPOSITORY_OWNER}/imi-swoole-test:${IMAGE_VERSION}
    environment:
      RUNNING_CI_RECTOR_CACHE_DIR: ${RUNNING_CI_RECTOR_CACHE_DIR}
    volumes:
      - "${GITHUB_WORKSPACE}:/imi:rw"
      - "/tmp/base_cache:/tmp/base_cache:rw"
      - "/tmp/base_cache/phpstan:/tmp/phpstan:rw"
    working_dir: /imi
    command: tail -f /dev/null
    tty: true